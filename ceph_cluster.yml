parameters:
 nodes: 3
 node_ip_offset: 100
 pool: default
 node_prefix_1: ceph
 network_1: ceph-orch
 ip_prefix_1: 192.168.100
 ipv6_prefix_1: ''  # Example of a real IPv6 prefix: '2620:52:0:1304'
 netmask: 255.255.255.0
 numcpus: 1
 memory: 6144
 image: fedora43
 notify: false
 admin_password: password
 network_interface_name: ens3
 network_interface_type: ipv4
 bootstrap_server_as_ntp_source: false  # if set as true, the first node will act as an ntp server for the rest of the nodes
 container_cfg:
   engine:
     env:   # when you are behind vpn or similar env and require to pass through a proxy ,put your proxy configyuration
       #- HTTP_PROXY: "http://example.net:8080"
       #- HTTPS_PROXY: "http://example.net:8080"
       #- http_proxy: "http://example.net:8080"
       #- https_proxy: "http://example.net:8080"
       - NO_PROXY: "localhost,127.0.0.1,{{ ip_prefix_1 }}.0/24"
 disks:
 - size: 100               # Disk 1 (OS)
 - size: 10                # Disk 2 (Ceph Data)

{% for number in range(0, nodes) %}
{{ node_prefix_1 }}-node-{{ '%d' % number }}:
 image: {{ image }}
 numcpus: {{ numcpus }}
 memory: {{ memory }}
 reserveip: true
 reservedns: true
 sharedkey: true
 user: fedora
 keys:
  - ~/.ssh/id_ed25519.pub
 nets:
  - name: {{ network_1 }}
    ip: {{ ip_prefix_1 }}.{{ node_ip_offset + number }}
    gateway: {{ ip_prefix_1 }}.1
    mask: {{ netmask }}
    dns: {{ ip_prefix_1 }}.1
    {% if ipv6_prefix_1 is defined and ipv6_prefix_1 %}
    ipv6: "{{ ipv6_prefix_1 }}::{{ '%x' % (node_ip_offset + number) }}"
    {% endif %}
 disks: {{ disks }}
 pool: {{ pool }}
 {% if ceph_dev_folder is defined %}
 sharedfolders: [{{ ceph_dev_folder }}]
 {% endif %}
 files:
  - bootstrap-cluster.sh
 cmds:
 {% if network_interface_type is defined and network_interface_type == 'ipv6' %}
 - connection_name=$(nmcli -g NAME,DEVICE con show | grep "{{ network_interface_name }}" | cut -d ':' -f1)
 - nmcli connection modify "$connection_name" ipv6.addresses "{{ ipv6_prefix_1 }}::{{ '%x' % (node_ip_offset + number) }}/64" ipv6.method manual
 - nmcli connection up "$connection_name"
 {% endif %}
 - dnf -y install python3 chrony lvm2 podman nano strace firewalld tcpdump net-tools vim
 - sed -i "s/SELINUX=enforcing/SELINUX=permissive/" /etc/selinux/config
 - setenforce 0
 {% if container_cfg is defined %}
 - mkdir -p /etc/containers
 - echo "[engine]" > /etc/containers/containers.conf
 - echo "env = [" >> /etc/containers/containers.conf
 {% for env_entry in container_cfg.engine.env %}
 {% set key_val = env_entry.items() | list | first %}
 - echo "    \"{{ key_val[0] }}={{ key_val[1] }}\"{{ ',' if not loop.last else '' }}" >> /etc/containers/containers.conf
 {% endfor %}
 - echo "]" >> /etc/containers/containers.conf
 {% endif %}
 {% if bootstrap_server_as_ntp_source is defined %}
 {% if number == 0 %}
 - sed -i -r '/^(server|pool) /d' /etc/chrony.conf
 - echo "local stratum 10" >> /etc/chrony.conf
 - echo "allow {{ ip_prefix_1 }}.0/24" >> /etc/chrony.conf
 - systemctl enable chronyd
 - systemctl restart chronyd
 {% else %}
 - sed -i -r '/^(server|pool) /d' /etc/chrony.conf
 - echo "server {{ ip_prefix_1 }}.{{ node_ip_offset }} iburst" >> /etc/chrony.conf
 - systemctl enable chronyd
 - systemctl restart chronyd
 {% endif %}
 {% endif %}
 {% if number == 0 %}
 - bash /root/bootstrap-cluster.sh
 {% endif %}
{% endfor %}
